<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°è¦‹ç© | DEVELOPMENT Pro | TAmJ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #E60012;
            --primary-dark: #C5000F;
            --white: #ffffff;
            --dark: #1d1d1d;
            --gray-text: #333333;
            --off-white: #ffffff;
            --border: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Inter", sans-serif; line-height: 1.6; color: var(--dark); background: #ffffff; }
        a { text-decoration: none; color: inherit; }

        header { background: var(--white); padding: 0.8rem 1.5rem; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 20px rgba(0,0,0,0.05); }
        .header-container { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo { font-family: "Bebas Neue", sans-serif; color: var(--primary); font-size: 1.6rem; }
        .logo .char-m { font-family: "Inter", sans-serif; font-weight: 300; font-size: 0.6em; }
        .back-link { color: var(--gray-text); font-size: 0.85rem; }
        .back-link:hover { color: var(--primary); }

        .main-container { max-width: 1200px; margin: 0 auto; padding: 80px 1.5rem 2rem; }
        .page-header { background: linear-gradient(135deg, #E60012, #C5000F); color: var(--white); padding: 1.5rem; border-radius: 14px; margin-bottom: 1.5rem; }
        .member-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 0.2rem 0.8rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; margin-bottom: 0.8rem; }
        .page-header h1 { font-family: "Bebas Neue", sans-serif; font-size: 1.5rem; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
        .page-header p { font-size: 0.8rem; opacity: 0.9; }

        .estimate-grid { display: grid; grid-template-columns: 1fr 320px; gap: 1.2rem; align-items: start; }
        @media (max-width: 1024px) { .estimate-grid { grid-template-columns: 1fr; } }

        .card { background: var(--white); border-radius: 14px; padding: 1.2rem; margin-bottom: 1.2rem; box-shadow: 0 2px 12px rgba(0,0,0,0.03); border: 1px solid var(--border); }
        .card h2 { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.4rem; }
        .card h2 .icon { width: 22px; height: 22px; background: linear-gradient(135deg, #E60012, #C5000F); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 0.7rem; }

        .data-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6; }
        .data-row:last-child { border-bottom: none; }
        .data-row .label { font-size: 0.8rem; color: var(--gray-text); }
        .data-row .value { font-size: 0.85rem; font-weight: 600; }
        .data-row.highlight { background: var(--off-white); margin: 0 -1.2rem; padding: 0.6rem 1.2rem; border-radius: 8px; margin-top: 0.4rem; }
        .data-row.highlight .value { color: var(--primary); font-size: 0.95rem; }

        .summary-sidebar { position: sticky; top: 80px; }
        .summary-card { background: var(--white); border-radius: 14px; padding: 1.2rem; box-shadow: 0 8px 30px rgba(230, 0, 18, 0.1); border: 2px solid var(--primary); margin-bottom: 0.8rem; }
        .summary-card h3 { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.8rem; }
        .summary-section { margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #f3f4f6; }
        .summary-section:last-of-type { border-bottom: none; }
        .summary-label { font-size: 0.65rem; color: var(--gray-text); margin-bottom: 0.15rem; text-transform: uppercase; }
        .summary-value { font-size: 1.1rem; font-weight: 700; }

        .yield-box { background: linear-gradient(135deg, #E60012, #C5000F); color: var(--white); padding: 0.8rem; border-radius: 10px; text-align: center; margin: 0.8rem 0; }
        .yield-box .label { font-size: 0.65rem; opacity: 0.9; }
        .yield-box .value { font-size: 1.5rem; font-weight: 700; }
        .yield-sub { display: flex; justify-content: space-around; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.75rem; }

        .summary-actions { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.8rem; }
        .btn { display: block; padding: 0.7rem 0.9rem; border-radius: 50px; font-weight: 600; font-size: 0.8rem; text-align: center; border: none; cursor: pointer; }
        .btn.primary { background: linear-gradient(135deg, #E60012, #C5000F); color: var(--white); }
        .btn.secondary { background: var(--white); color: var(--primary); border: 2px solid var(--primary); }

        .empty-state { text-align: center; padding: 3rem 1.5rem; background: var(--white); border-radius: 14px; grid-column: 1 / -1; }
        .empty-state h2 { font-size: 1.1rem; margin-bottom: 0.8rem; }
        .empty-state p { color: var(--gray-text); margin-bottom: 1.5rem; }

        .task-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .task-tag { display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.25rem 0.6rem; background: var(--off-white); border-radius: 50px; font-size: 0.7rem; }
        .task-tag .phase { background: var(--primary); color: var(--white); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; font-weight: 700; }

        .notes-card { background: var(--white); border-radius: 14px; padding: 0.8rem; box-shadow: 0 2px 12px rgba(0,0,0,0.03); border: 1px solid var(--border); }
        .notes-card h4 { font-size: 0.8rem; font-weight: 700; margin-bottom: 0.5rem; }
        .notes-card ul { list-style: none; }
        .notes-card li { font-size: 0.65rem; color: var(--gray-text); padding: 0.15rem 0 0.15rem 0.8rem; position: relative; }
        .notes-card li::before { content: 'â€¢'; position: absolute; left: 0; color: var(--primary); }

        /* å†…è¨³ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .breakdown-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 0.5rem; }
        .breakdown-table th { background: var(--off-white); padding: 0.5rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--primary); }
        .breakdown-table th:last-child, .breakdown-table td:last-child { text-align: right; }
        .breakdown-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid #f3f4f6; }
        .breakdown-table tr.category { background: #fdf8fc; }
        .breakdown-table tr.category td { font-weight: 600; color: var(--primary-dark); }
        .breakdown-table tr.subtotal { background: var(--off-white); }
        .breakdown-table tr.subtotal td { font-weight: 700; }
        .breakdown-table tr.total { background: linear-gradient(135deg, #E60012, #C5000F); color: white; }
        .breakdown-table tr.total td { font-weight: 700; padding: 0.6rem 0.5rem; }
        .breakdown-table .sub-item { padding-left: 1.5rem; color: var(--gray-text); }
        .breakdown-table .note { font-size: 0.65rem; color: var(--gray-text); }

        .section-badge { display: inline-block; background: var(--primary); color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-left: 0.5rem; }

        @media (max-width: 768px) { .main-container { padding: 70px 1rem 1.5rem; } }
        @media print { header, .summary-actions { display: none; } .estimate-grid { display: block; } }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="home.html" class="logo"><img src="logo.png" alt="TAmJ" style="height: 28px;"></a>
            <a href="service-development.html" class="back-link">â† ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹</a>
        </div>
    </header>

    <main class="main-container">
        <div class="page-header">
            <span class="member-badge">MEMBER ESTIMATE v6</span>
            <h1>é–‹ç™ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ è©³ç´°è¦‹ç©</h1>
            <p id="headerTimestamp">ä½œæˆæ—¥æ™‚: -</p>
        </div>
        <div class="estimate-grid" id="estimateContent"></div>
    </main>

    <script>
        const facilityNames = { tokuyo:'ç‰¹é¤Š', yuryo:'æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ', sakouju:'ã‚µé«˜ä½', groupHome:'ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ' };
        function yen(n){ return "Â¥"+Math.round(Number(n||0)).toLocaleString("ja-JP"); }
        function yenShort(n){ n=Number(n||0); if(n>=1e8) return "Â¥"+(n/1e8).toFixed(2)+"å„„"; if(n>=1e4) return "Â¥"+Math.round(n/1e4).toLocaleString()+"ä¸‡"; return yen(n); }
        function yenRange(min,max){ return `${yenShort(min)}ã€œ${yenShort(max)}`; }
        function formatDate(iso){ const d=new Date(iso); return d.toLocaleDateString('ja-JP')+' '+d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}); }

        // Aå·¥äº‹å†…è¨³æ¯”ç‡ï¼ˆå»ºç¯‰è²»ã«å¯¾ã™ã‚‹æ¯”ç‡ã€ä»‹è­·æ–½è¨­æ¨™æº–ï¼‰
        const A_BREAKDOWN_RATIOS = [
            { category: 'ä»®è¨­å·¥äº‹', ratio: 0.06, items: [
                { name: 'å…±é€šä»®è¨­', ratio: 0.35, note: 'ä»®å›²ã„ã€ä»®è¨­é›»æ°—æ°´é“ã€ç¾å ´äº‹å‹™æ‰€ç­‰' },
                { name: 'ç›´æ¥ä»®è¨­', ratio: 0.65, note: 'è¶³å ´ã€é¤Šç”Ÿã€å®‰å…¨è¨­å‚™' }
            ]},
            { category: 'åœŸå·¥äº‹', ratio: 0.04, items: [
                { name: 'æ˜å‰Šãƒ»åŸ‹æˆ»ã—', ratio: 0.70, note: 'æ ¹åˆ‡ã‚Šã€åŸ‹æˆ»ã—ã€æ®‹åœŸå‡¦åˆ†' },
                { name: 'åœ°æ¥­', ratio: 0.30, note: 'ç •çŸ³åœ°æ¥­ã€è»¢åœ§' }
            ]},
            { category: 'èº¯ä½“å·¥äº‹', ratio: 0.25, items: [
                { name: 'åŸºç¤', ratio: 0.30, note: 'åŸºç¤ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã€å‹æ ã€é…ç­‹' },
                { name: 'æ§‹é€ èº¯ä½“', ratio: 0.70, note: 'æŸ±ãƒ»æ¢ãƒ»åºŠãƒ»å£ï¼ˆRC/Sï¼‰' }
            ]},
            { category: 'é˜²æ°´å·¥äº‹', ratio: 0.03, items: [
                { name: 'å±‹ä¸Šé˜²æ°´', ratio: 0.70, note: 'å±‹ä¸Šã€ãƒãƒ«ã‚³ãƒ‹ãƒ¼é˜²æ°´' },
                { name: 'æµ´å®¤é˜²æ°´', ratio: 0.30, note: 'æµ´å®¤ãƒ»æ©Ÿæ¢°æµ´å®¤åºŠé˜²æ°´' }
            ]},
            { category: 'å¤–è£…å·¥äº‹', ratio: 0.10, items: [
                { name: 'å¤–å£', ratio: 0.65, note: 'å¤–å£ä»•ä¸Šï¼ˆALCã€ãƒ‘ãƒãƒ«ç­‰ï¼‰' },
                { name: 'é–‹å£éƒ¨', ratio: 0.35, note: 'ã‚µãƒƒã‚·ã€è‡ªå‹•ãƒ‰ã‚¢' }
            ]},
            { category: 'å†…è£…å·¥äº‹', ratio: 0.15, items: [
                { name: 'å…±ç”¨éƒ¨ä»•ä¸Š', ratio: 0.25, note: 'å»Šä¸‹ãƒ»ãƒ›ãƒ¼ãƒ«åºŠå£å¤©äº•ï¼ˆé•·å°ºã‚·ãƒ¼ãƒˆç­‰ï¼‰' },
                { name: 'å±…å®¤ä»•ä¸Š', ratio: 0.35, note: 'å±…å®¤åºŠãƒ»å£ãƒ»å¤©äº•' },
                { name: 'å»ºå…·', ratio: 0.25, note: 'å±…å®¤æ‰‰ã€å…±ç”¨éƒ¨å»ºå…·' },
                { name: 'é€ ä½œ', ratio: 0.15, note: 'åç´ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç­‰' }
            ]},
            { category: 'çµ¦æ’æ°´è¡›ç”Ÿè¨­å‚™', ratio: 0.15, items: [
                { name: 'çµ¦æ°´ãƒ»çµ¦æ¹¯', ratio: 0.25, note: 'å±…å®¤ãƒ»å…±ç”¨éƒ¨çµ¦æ°´çµ¦æ¹¯' },
                { name: 'æ’æ°´', ratio: 0.15, note: 'æ±šæ°´ãƒ»é›‘æ’æ°´' },
                { name: 'è¡›ç”Ÿå™¨å…·', ratio: 0.35, note: 'å…¨å±…å®¤ãƒˆã‚¤ãƒ¬ãƒ»æ´—é¢ã€å…±ç”¨ãƒˆã‚¤ãƒ¬' },
                { name: 'æµ´å®¤è¨­å‚™', ratio: 0.25, note: 'ä¸€èˆ¬æµ´ã€æ©Ÿæ¢°æµ´æ§½æ®ä»˜ï¼ˆè¨­å‚™æ‰±ã„ï¼‰' }
            ]},
            { category: 'ç©ºèª¿æ›æ°—è¨­å‚™', ratio: 0.08, items: [
                { name: 'ç©ºèª¿', ratio: 0.70, note: 'å…¨å±…å®¤ã‚¨ã‚¢ã‚³ãƒ³ã€å…±ç”¨éƒ¨ç©ºèª¿' },
                { name: 'æ›æ°—', ratio: 0.30, note: '24æ™‚é–“æ›æ°—ã€æµ´å®¤æ›æ°—' }
            ]},
            { category: 'é›»æ°—è¨­å‚™', ratio: 0.10, items: [
                { name: 'å—å¤‰é›»', ratio: 0.20, note: 'å—é›»ç›¤ã€åˆ†é›»ç›¤' },
                { name: 'ç…§æ˜', ratio: 0.30, note: 'å±…å®¤ãƒ»å…±ç”¨éƒ¨ç…§æ˜ã€éå¸¸ç…§æ˜' },
                { name: 'å¼±é›»', ratio: 0.30, note: 'ãƒŠãƒ¼ã‚¹ã‚³ãƒ¼ãƒ«ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ›ãƒ³ç­‰é…ç·š' },
                { name: 'é˜²ç½', ratio: 0.20, note: 'è‡ªç«å ±ã€èª˜å°ç¯' }
            ]},
            { category: 'å¤–æ§‹å·¥äº‹', ratio: 0.04, items: [
                { name: 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ', ratio: 0.60, note: 'ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ã‚¹ãƒ­ãƒ¼ãƒ—' },
                { name: 'å¤–éƒ¨è¨­å‚™', ratio: 0.40, note: 'å¤–éƒ¨çµ¦æ’æ°´ã€å¤–éƒ¨æ‰‹æ‘º' }
            ]}
        ];

        // Bå·¥äº‹å†…è¨³ï¼ˆå›ºå®šè²»ç›®å®‰ï¼‰
        const B_BREAKDOWN = [
            { name: 'ã‚µã‚¤ãƒ³ãƒ»çœ‹æ¿', note: 'é¤¨å†…ã‚µã‚¤ãƒ³ã€æ¡ˆå†…æ¿', unitPrice: 500000 },
            { name: 'é˜²çŠ¯ãƒ»ç›£è¦–', note: 'ç›£è¦–ã‚«ãƒ¡ãƒ©ã€å…¥é€€å®¤ç®¡ç†', perRoom: 30000 },
            { name: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…ç·š', note: 'LANé…ç·šã€Wi-Fi APè¨­ç½®', perRoom: 25000 },
            { name: 'ã‚«ãƒ¼ãƒ†ãƒ³ãƒ¬ãƒ¼ãƒ«', note: 'ã‚«ãƒ¼ãƒ†ãƒ³ãƒ¬ãƒ¼ãƒ«ä¸€å¼', perRoom: 15000 }
        ];

        function generateBreakdownTable(buildCostMid, residents, gfa) {
            let html = '<table class="breakdown-table">';
            html += '<tr><th>å·¥äº‹é …ç›®</th><th>å†…å®¹</th><th>é‡‘é¡ï¼ˆç¨æŠœï¼‰</th></tr>';
            
            let totalA = 0;
            
            // Aå·¥äº‹å†…è¨³
            A_BREAKDOWN_RATIOS.forEach(cat => {
                const catTotal = buildCostMid * cat.ratio;
                totalA += catTotal;
                
                html += `<tr class="category"><td colspan="2">${cat.category}</td><td>${yen(catTotal)}</td></tr>`;
                
                cat.items.forEach(item => {
                    const itemCost = catTotal * item.ratio;
                    html += `<tr><td class="sub-item">${item.name}</td><td class="note">${item.note}</td><td>${yen(itemCost)}</td></tr>`;
                });
            });
            
            html += `<tr class="subtotal"><td colspan="2">Aå·¥äº‹ å°è¨ˆ</td><td>${yen(totalA)}</td></tr>`;
            
            // Bå·¥äº‹å†…è¨³
            let totalB = 0;
            html += `<tr class="category"><td colspan="3" style="background:var(--off-white);color:var(--primary-dark);">Bå·¥äº‹ï¼ˆä»˜å¸¯å·¥äº‹ï¼‰</td></tr>`;
            
            B_BREAKDOWN.forEach(item => {
                let cost = 0;
                if(item.unitPrice) cost = item.unitPrice;
                if(item.perRoom) cost = item.perRoom * residents;
                totalB += cost;
                html += `<tr><td class="sub-item">${item.name}</td><td class="note">${item.note}</td><td>${yen(cost)}</td></tr>`;
            });
            
            html += `<tr class="subtotal"><td colspan="2">Bå·¥äº‹ å°è¨ˆ</td><td>${yen(totalB)}</td></tr>`;
            
            html += `<tr class="total"><td colspan="2">A+Bå·¥äº‹ åˆè¨ˆï¼ˆç¨æŠœï¼‰</td><td>${yen(totalA + totalB)}</td></tr>`;
            
            html += '</table>';
            
            // å˜ä¾¡æƒ…å ±
            html += `<div style="margin-top:0.8rem;padding:0.6rem;background:#ffffff;border-radius:8px;font-size:0.7rem;color:var(--gray-text);">`;
            html += `<div style="display:flex;gap:1rem;flex-wrap:wrap;">`;
            html += `<span>ã¡å˜ä¾¡: <b style="color:var(--dark);">${yen(buildCostMid/gfa)}/ã¡</b></span>`;
            html += `<span>åªå˜ä¾¡: <b style="color:var(--dark);">${yen(buildCostMid/gfa*3.3)}/åª</b></span>`;
            html += `<span>å»¶åºŠé¢ç©: <b style="color:var(--dark);">${gfa.toLocaleString()}ã¡</b></span>`;
            html += `</div></div>`;
            
            return html;
        }

        function render(){
            const raw=localStorage.getItem('devSimulation');
            const container=document.getElementById('estimateContent');
            if(!raw){
                container.innerHTML=`<div class="empty-state"><h2>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2><p>é–‹ç™ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã§æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p><a href="service-development.html" class="btn primary" style="display:inline-block;padding:0.8rem 1.5rem;">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¸</a></div>`;
                return;
            }
            const data=JSON.parse(raw);
            document.getElementById('headerTimestamp').textContent='ä½œæˆæ—¥æ™‚: '+formatDate(data.savedAt);
            const fac=data.facility||{};
            const inp=data.inputs||{};
            const comp=data.computed||{};
            const land=inp.land||{};
            const tasks=data.selectedTasks||[];
            const landMode=land.mode==='lease'?'å€Ÿåœ°':'è³¼å…¥';
            const totalLandFees=(land.auto==='auto'?(land.landFees_auto_net||0):0)+(land.landFees_manual_net||0);
            
            const buildMin = comp.build?.min || 0;
            const buildMax = comp.build?.max || 0;
            const buildMid = (buildMin + buildMax) / 2;
            const gfa = inp.gfa_m2 || 1;
            const residents = fac.residents || 50;

            container.innerHTML=`
                <div class="estimate-main">
                    <div class="card">
                        <h2><span class="icon">0</span> æ–½è¨­è¨ˆç”»</h2>
                        <div class="data-row"><span class="label">æ–½è¨­ç¨®åˆ¥</span><span class="value">${facilityNames[fac.facilityType]||fac.facilityType||'-'}</span></div>
                        <div class="data-row"><span class="label">å…¥å±…è€…æ•°</span><span class="value">${residents} äºº</span></div>
                        <div class="data-row"><span class="label">å€‹å®¤é¢ç©</span><span class="value">${fac.privateArea||0} ã¡/å®¤</span></div>
                        <div class="data-row"><span class="label">ãƒ¬ãƒ³ã‚¿ãƒ–ãƒ«æ¯”</span><span class="value">${fac.rentableRatio||0}%</span></div>
                    </div>
                    <div class="card">
                        <h2><span class="icon">1</span> å»ºç¯‰æ¡ä»¶</h2>
                        <div class="data-row"><span class="label">éƒ½é“åºœçœŒ</span><span class="value">${inp.pref||'-'}</span></div>
                        <div class="data-row"><span class="label">æ§‹é€ </span><span class="value">${inp.structure||'-'}</span></div>
                        <div class="data-row"><span class="label">éšæ•°</span><span class="value">${inp.floors||2} éš</span></div>
                        <div class="data-row"><span class="label">å»¶åºŠé¢ç©</span><span class="value">${(inp.gfa_m2||0).toLocaleString()} ã¡</span></div>
                        <div class="data-row"><span class="label">ç”¨é€”ä¿‚æ•° / æŒ‡æ•°</span><span class="value">Ã—${inp.useFactor||1.25} / Ã—${inp.indexFactor||1.10}</span></div>
                    </div>
                    <div class="card">
                        <h2><span class="icon">2</span> åœŸåœ°ãƒ»ä»•å…¥</h2>
                        <div class="data-row"><span class="label">åœŸåœ°å½¢æ…‹</span><span class="value">${landMode}</span></div>
                        ${land.mode==='purchase'?`<div class="data-row"><span class="label">åœŸåœ°ä»•å…¥ä¾¡æ ¼</span><span class="value">${yenShort(land.land_price||0)}</span></div>`:`<div class="data-row"><span class="label">æœˆé¡åœ°ä»£</span><span class="value">${yenShort(land.ground_rent_month||0)}/æœˆ</span></div>`}
                        <div class="data-row"><span class="label">åœŸåœ°é–¢é€£è«¸è²»ç”¨</span><span class="value">${yenShort(totalLandFees)}</span></div>
                    </div>
                    <div class="card">
                        <h2><span class="icon">3</span> å»ºç¯‰è²»ï¼ˆA+Bå·¥äº‹ï¼‰å†…è¨³ <span class="section-badge">ç¨æŠœ</span></h2>
                        <div class="data-row highlight"><span class="label">å»ºç¯‰è²»æ¦‚ç®—</span><span class="value">${yenRange(buildMin, buildMax)}</span></div>
                        ${generateBreakdownTable(buildMid, residents, gfa)}
                    </div>
                    <div class="card">
                        <h2><span class="icon">4</span> ãã®ä»–è²»ç”¨</h2>
                        <div class="data-row"><span class="label">é–‹ç™ºä½œæ¥­è²»</span><span class="value">${yenRange(comp.devTasksCost?.min||0, comp.devTasksCost?.max||0)}</span></div>
                        <div class="data-row highlight"><span class="label">æŠ•è³‡ç·é¡ï¼ˆç¨è¾¼æ¦‚ç®—ï¼‰</span><span class="value">${yenRange(comp.summary?.totalMin||0, comp.summary?.totalMax||0)}</span></div>
                    </div>
                    <div class="card">
                        <h2><span class="icon">5</span> é¸æŠã—ãŸé–‹ç™ºä½œæ¥­</h2>
                        ${tasks.length>0?`<div class="task-list">${tasks.map(t=>`<span class="task-tag"><span class="phase">${t.split('-')[0]}</span>${t}</span>`).join('')}</div>`:'<p style="color:var(--gray-text);font-size:0.8rem;">é¸æŠãªã—</p>'}
                    </div>
                    <div class="card">
                        <h2><span class="icon">6</span> åæ”¯</h2>
                        <div class="data-row"><span class="label">å¹´é–“åå…¥</span><span class="value">${yenShort(comp.summary?.incomeY||0)}</span></div>
                        <div class="data-row highlight"><span class="label">å¹´é–“NOI</span><span class="value">${yenShort(comp.summary?.noiY||0)}</span></div>
                    </div>
                </div>
                <div class="summary-sidebar">
                    <div class="summary-card">
                        <h3>ğŸ“Š è¦‹ç©ã‚µãƒãƒªãƒ¼</h3>
                        <div class="summary-section"><div class="summary-label">æ–½è¨­ç¨®åˆ¥</div><div class="summary-value" style="font-size:0.85rem;">${facilityNames[fac.facilityType]||'-'} / ${residents}äºº</div></div>
                        <div class="summary-section"><div class="summary-label">æŠ•è³‡ç·é¡ï¼ˆæ¦‚ç®—ï¼‰</div><div class="summary-value">${yenShort(((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2)}</div></div>
                        <div class="summary-section"><div class="summary-label">å¹´é–“NOI</div><div class="summary-value">${yenShort(comp.summary?.noiY||0)}</div></div>
                        <div class="yield-box">
                            <div class="label">NOIåˆ©å›ã‚Š</div>
                            <div class="value">${(comp.summary?.noiYield||0).toFixed(2)}%</div>
                            <div class="yield-sub">
                                <span>è¡¨é¢: ${(comp.summary?.grossYield||0).toFixed(1)}%</span>
                                <span>å›å: ${comp.summary?.noiY>0?(((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2/comp.summary?.noiY).toFixed(1):'-'}å¹´</span>
                            </div>
                        </div>
                        <div class="summary-actions">
                            <button class="btn primary" onclick="window.print()">ğŸ“„ å°åˆ· / PDFä¿å­˜</button>
                            <button class="btn secondary" onclick="exportCSV()">ğŸ“Š CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                            <a href="mailto:info@tamjump.com?subject=é–‹ç™ºè¦‹ç©ã®ã”ç›¸è«‡" class="btn secondary" style="text-decoration:none;">âœ‰ï¸ æ­£å¼è¦‹ç©ã‚’ä¾é ¼</a>
                        </div>
                    </div>
                    <div class="notes-card">
                        <h4>ğŸ’¡ ã”æ³¨æ„</h4>
                        <ul>
                            <li>æœ¬è¦‹ç©ã¯æ¦‚ç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™</li>
                            <li>Aå·¥äº‹å˜ä¾¡ãƒ™ãƒ¼ã‚¹ï¼ˆå‹•ç”£é™¤å¤–ï¼‰</li>
                            <li>Bå·¥äº‹ã¯ä»˜å¸¯å·¥äº‹ã®å‚è€ƒå€¤</li>
                            <li>Cå·¥äº‹ï¼ˆä»€å™¨å‚™å“ï¼‰ã¯åˆ¥é€”</li>
                            <li>æ­£å¼è¦‹ç©ã¯ãƒ’ã‚¢ãƒªãƒ³ã‚°å¾Œã«ä½œæˆ</li>
                        </ul>
                    </div>
                </div>`;
        }

        function exportCSV(){
            const raw=localStorage.getItem('devSimulation');
            if(!raw){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            const data=JSON.parse(raw);
            const fac=data.facility||{};
            const inp=data.inputs||{};
            const comp=data.computed||{};
            const buildMid = ((comp.build?.min||0) + (comp.build?.max||0)) / 2;
            const gfa = inp.gfa_m2 || 1;
            
            let csv='é …ç›®,å€¤\n';
            csv+=`æ–½è¨­ç¨®åˆ¥,${facilityNames[fac.facilityType]||fac.facilityType}\n`;
            csv+=`å…¥å±…è€…æ•°,${fac.residents}\n`;
            csv+=`éƒ½é“åºœçœŒ,${inp.pref}\n`;
            csv+=`æ§‹é€ ,${inp.structure}\n`;
            csv+=`éšæ•°,${inp.floors||2}\n`;
            csv+=`å»¶åºŠé¢ç©,${inp.gfa_m2}ã¡\n`;
            csv+=`ã¡å˜ä¾¡,${Math.round(buildMid/gfa)}å††/ã¡\n`;
            csv+=`åªå˜ä¾¡,${Math.round(buildMid/gfa*3.3)}å††/åª\n`;
            csv+=`å»ºç¯‰è²»ï¼ˆMINï¼‰,${comp.build?.min||0}\n`;
            csv+=`å»ºç¯‰è²»ï¼ˆMAXï¼‰,${comp.build?.max||0}\n`;
            csv+='\nAå·¥äº‹å†…è¨³,é‡‘é¡\n';
            A_BREAKDOWN_RATIOS.forEach(cat => {
                csv+=`${cat.category},${Math.round(buildMid * cat.ratio)}\n`;
            });
            csv+='\n';
            csv+=`æŠ•è³‡ç·é¡ï¼ˆMINï¼‰,${comp.summary?.totalMin||0}\n`;
            csv+=`æŠ•è³‡ç·é¡ï¼ˆMAXï¼‰,${comp.summary?.totalMax||0}\n`;
            csv+=`å¹´é–“NOI,${comp.summary?.noiY||0}\n`;
            csv+=`NOIåˆ©å›ã‚Š,${(comp.summary?.noiYield||0).toFixed(2)}%\n`;
            const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
            const link=document.createElement('a');
            link.href=URL.createObjectURL(blob);
            link.download='development_estimate_v6_'+new Date().toISOString().slice(0,10)+'.csv';
            link.click();
        }

        render();
    </script>
</body>
</html>
